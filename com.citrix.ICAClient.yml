id: com.citrix.ICAClient
runtime: org.gnome.Platform
runtime-version: "42" # Requirements as per Citrix's site: https://docs.citrix.com/en-us/citrix-workspace-app-for-linux/system-requirements.html
sdk: org.gnome.Sdk
command: /app/bin/run.sh

build-options:
  build-args:
    - --share=network

finish-args:
  - --device=all # For webcam access
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
  - --share=ipc # Required for X11 to work properly
  - --env=ICAROOT=/app/ICAClient
  - --filesystem=xdg-download # Access to downloaded ica files
  - --persist=. # Gives the app a persistent that is treated as the home directory, located at ~/.var/app/com.citrix.ICAClient
  - --persist=.ICAClient # Log/config directory (relative to the Flatpak container home folder)

modules:
  - name: icaclient
    buildsystem: simple
    build-commands:
      - |
        folder=""
        arch=$(uname -m)
        if [[ "$arch" == "x86_64" ]]; then
          folder="linuxx64"
        elif [[ "$arch" == "aarch64" ]]; then
          folder="linuxarm64"
        else
          echo "Unsupported architecture. This should not happen."
          exit 1
        fi

        url=$(wget -q -O - https://www.citrix.com/downloads/workspace-app/linux/workspace-app-for-linux-latest.html | sed -ne "/${folder}.*tar.gz/ s/<a .* rel=\"\(.*\)\" id=\"downloadcomponent.*\">/https:\1/p" | sed -e 's/\r//g' | xargs)
        echo "Downloading Citrix Workspace from ${url}"
        wget -nv --show-progress "${url}" -O /tmp/linux.tar.gz

        if [ ! -f /tmp/linux.tar.gz ]; then
          exit 1
        fi

        mkdir /tmp/icaclient
        echo "Unpacking.."
        tar -zxf /tmp/linux.tar.gz --directory=/tmp/icaclient

        chmod +x install.sh
        ./install.sh

        install -Dm 644 /tmp/icaclient/${folder}/${folder}.cor/icons/000_Receiver_64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png
        install -Dm 644 /tmp/icaclient/${folder}/${folder}.cor/icons/receiver.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png

      - ln -s /etc/ssl/certs/*.pem /app/ICAClient/keystore/cacerts/
      - /app/ICAClient/util/ctx_rehash /app/ICAClient/keystore/cacerts/

      - install -Dm 644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm 644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm 755 run.sh ${FLATPAK_DEST}/bin/run.sh

    sources:
      - type: file
        path: install.sh
      - type: file
        path: com.citrix.ICAClient.metainfo.xml
      - type: file
        path: com.citrix.ICAClient.desktop
      - type: file
        path: run.sh

